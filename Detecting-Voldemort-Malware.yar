/* 
    Enhanced Comprehensive YARA Rule for Detecting Voldemort Malware
	Source : https://github.com/RemusDBD/Detecting-Voldemort-Malware
*/

rule voldemort_comprehensive {
   meta:
      description = "Enhanced comprehensive detection of Voldemort malware used in espionage campaigns"
      author = "Remus"
      reference = "https://www.proofpoint.com/us/blog/threat-insight/malware-must-not-be-named-suspected-espionage-campaign-delivers-voldemort"
      date = "2024-09-07"
   strings:
      // Known DLL side-loading target
      $dll_hijacking = "CiscoSparkLauncher.dll"
      
      // Known malware executable
      $malware_file = "CiscoCollabHost.exe"

      // Strings related to C2 communication and decryption
      $c2_google_sheet = "sheets.googleapis.com/v4/spreadsheets"
      $egg_hunting_marker = "g00"
      $c2_uri = "/ows/v1/OutlookCloudSettings/settings/global"
      $google_sheet_id = "16JvcER-0TVQDimWV56syk91IMCYXOvZbW4GTnb947eE"

      // Decoy files
      $decoy_pdf1 = "ABC_of_Tax.zip"
      $decoy_pdf2 = "La_dichiarazione_precompilata_2024.pdf"

      // Indicators of malware activity
      $uuid_check = "UUID"
      $voldemort_command = "Voldemort"
      
      // Specific file paths and attributes observed in the malware
      $search_ms_view = "<viewInfo iconSize=\"32\" stackIconSize=\"0\" displayName=\"Downloads\" autoListFlags=\"0\">"
      $search_ms_condition = "<condition type=\"leafCondition\" property=\"System.FileName\" operator=\"starts with\" propertyType=\"string\" value=\"ABC_of_Tax.zip\" localeName=\"en-US\">"
      $search_ms_include = "<include path=\"::{F02C1A0D-BE21-4350-88B0-7367FC96EF3C}\\invasion-prisoners-inns-aging.trycloudflare.com@SSL\\pub\" attributes=\"1887437133\"/>"

      // Additional behavioral and network indicators
      $malicious_lnk_file = ".lnk" // Detecting Windows shortcut files
      $malicious_zip_file = ".zip" // Detecting ZIP files used for delivery
      $power_shell_cmd = "powershell" // Detecting PowerShell usage
      $cobalt_strike_marker = "Cobalt Strike" // Known payload marker

      // Advanced indicators
      $network_request = "GET /api/v1/data" // Detecting specific network requests
      $encrypted_payload = "X1Y2Z3" // Known encrypted payload marker
      $self_modifying_code = "selfmod" // Detecting self-modifying code
      $suspicious_registry_key = "HKEY_CURRENT_USER\\Software\\Voldemort" // Suspicious registry key

      // Regular expressions for dynamic detection
      $dynamic_c2_pattern = /sheets\.googleapis\.com\/v4\/spreadsheets\/[A-Za-z0-9_-]+/ // Regex for dynamic C2 patterns

   condition:
      // Ensure key components and behaviors are detected
      any of ($dll_hijacking, $malware_file, $c2_google_sheet, $egg_hunting_marker, $c2_uri, $google_sheet_id) or
      (all of ($uuid_check, $voldemort_command) and
      any of ($search_ms_view, $search_ms_condition, $search_ms_include)) or
      (any of ($malicious_lnk_file, $malicious_zip_file, $power_shell_cmd, $cobalt_strike_marker) and
       any of ($network_request, $encrypted_payload, $self_modifying_code, $suspicious_registry_key, $dynamic_c2_pattern))
}
